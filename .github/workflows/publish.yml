name: Publish

on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    environment: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'
      - name: Configure npm auth (write to active npmrc)
        run: |
          npmrc="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"
          echo "Using npmrc: $npmrc"
          mkdir -p "$(dirname "$npmrc")"
          printf "registry=https://registry.npmjs.org/\n" > "$npmrc"
          printf "always-auth=true\n" >> "$npmrc"
          printf "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}\n" >> "$npmrc"
      - name: Confirm auth (safe)
        run: |
          echo "npm userconfig: $(npm config get userconfig)"
          echo "npm registry: $(npm config get registry)"
          if grep -q "//registry.npmjs.org/:_authToken" "${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"; then
            echo "found auth entry in npmrc"
          else
            echo "auth entry not found in npmrc"
          fi
          npm whoami || echo "NOT_LOGGED_IN"
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - name: Publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm publish --no-git-checks --access public
