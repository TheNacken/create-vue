name: Publish

on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    # Use Publish environment for deployment protection
    environment: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v5
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'
      # Ensure npm 11.5.1 or later is installed
      - name: Update npm
        run: npm install -g npm@latest
      - run: pnpm install
      - name: Configure npm auth (create ~/.npmrc)
        run: |
          echo "registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
      - name: Diagnose auth (safe)
        run: |
          echo "registry: $(npm config get registry)"
          npm whoami || echo "NOT_LOGGED_IN"
          npm view create-vue-enhanced --json || echo "no public info / inaccessible"
          npm owner ls create-vue-enhanced || echo "owner list unavailable / package not present"
      - run: pnpm publish --no-git-checks
